version: "3.7"

# YAML Anchors

x-deployment-env: &deployment-env
  ENV: ${ENV:-development}
  SG_ENV: ${SG_ENV:-development}

x-build-client-env: &build-client-env
  PLACEOS_BUILD_HOST: ${PLACEOS_BUILD_HOST:-build}
  PLACEOS_BUILD_PORT: ${PLACEOS_BUILD_PORT:-3000}

x-etcd-client-env: &etcd-client-env
  ETCD_HOST: ${ETCD_HOST:-etcd}
  ETCD_PORT: ${ETCD_PORT:-2379}

x-redis-client-env: &redis-client-env
  REDIS_URL: ${REDIS_URL:-redis://redis:6379}

x-rethinkdb-client-env: &rethinkdb-client-env
  RETHINKDB_HOST: ${RETHINKDB_HOST:-rethink}
  RETHINKDB_PORT: ${RETHINKDB_PORT:-28015}
  RETHINKDB_DB: ${RETHINKDB_DB:-place_development}

services:
  test: # Module coordinator
    image: placeos/service-spec-runner:${CRYSTAL_VERSION:-1.4.1}
    init: true
    volumes:
      - ${PWD}/bin:/app/bin:rw
      - ${PWD}/.test-drivers/test:/app/bin/drivers:rw
      - ${PWD}/lib:/app/lib:rw
      - ${PWD}/shard.lock:/app/shard.lock:rw
      - ${PWD}/shard.yml:/app/shard.yml:rw
      - ${PWD}/shard.override.yml:/app/shard.override.yml:rw
      - ${PWD}/spec:/app/spec:rw
      - ${PWD}/src:/app/src:rw
    depends_on:
      - build
      - etcd
      - redis
      - rethink
    security_opt:
      - seccomp:unconfined
    environment:
      GITHUB_ACTION: ${GITHUB_ACTION:-}
      # Service Hosts
      << : *build-client-env
      # Upstream Hosts
      << : *etcd-client-env
      << : *redis-client-env
      << : *rethinkdb-client-env
      # Environment
      << : *deployment-env

  build:
    image: placeos/build:${PLACE_BUILD_TAG:-nightly}
    restart: always
    hostname: build
    volumes:
      - ${PWD}/.test-drivers/build:/app/bin/drivers:rw
    environment:
      TZ: $TZ
      LOG_LEVEL: trace

  redis:
    image: eqalpha/keydb:alpine
    restart: always
    hostname: redis

  rethink:
    image: rethinkdb:${RETHINKDB_VERSION:-2.4}
    restart: always
    hostname: rethink

  etcd:
    image: bitnami/etcd:${ETCD_VERSION:-3.5.1}
    restart: always
    hostname: etcd
    environment:
      ALLOW_NONE_AUTHENTICATION: "yes"
